-- =============================================
-- MIGRACI칍N FASE 1: INVENTARIO Y MEN칔
-- =============================================

-- 1. Tabla de Categor칤as
create table if not exists public.categories (
  id bigint generated by default as identity primary key,
  name text not null,
  icon text,
  created_at timestamptz default now()
);

-- 2. Tabla de Productos
create table if not exists public.products (
  id bigint generated by default as identity primary key,
  category_id bigint references public.categories(id),
  name text not null,
  description text,
  price numeric not null,
  image text,
  stock int default 0,
  stock_threshold int default 5,
  available boolean default true,
  
  -- Guardaremos arrays y objetos como JSONB para flexibilidad
  base_ingredients jsonb default '[]'::jsonb, -- ["Pan", "Carne"]
  extras jsonb default '[]'::jsonb,           -- [{"name": "Queso", "price": 2000}]
  branch_prices jsonb default '{}'::jsonb,    -- {"Sede Norte": 15000}
  
  created_at timestamptz default now()
);

-- 3. Habilitar Realtime (Para que el men칰 se actualice solo)
alter publication supabase_realtime add table public.categories;
alter publication supabase_realtime add table public.products;

-- 4. Pol칤ticas de Seguridad (RLS)
-- Por ahora, permitimos lectura/escritura p칰blica para facilitar la migraci칩n sin login complejo inicial.
-- En producci칩n, esto deber칤a restringirse a usuarios autenticados.

alter table public.categories enable row level security;
alter table public.products enable row level security;

create policy "Acceso Publico Categorias" on public.categories for all using (true) with check (true);
create policy "Acceso Publico Productos" on public.products for all using (true) with check (true);

-- 5. Datos Iniciales (Opcional - Migrar lo b치sico si est치 vac칤o)
-- Solo insertamos si la tabla est치 vac칤a para no duplicar en ejecuciones futuras
do $$
begin
  if not exists (select 1 from public.categories) then
    insert into public.categories (name, icon) values
    ('Hamburguesas', '游꼢'),
    ('Salchipapas', '游'),
    ('Bebidas', '游볷');
  end if;
end $$;
